<div class="step-container fade-in">
  <div class="row justify-content-center">
    <div class="col-lg-10 col-xl-9">
      <div class="card-modern p-4">
        <!-- Header -->
        <div class="d-flex align-items-center mb-4">
          <div class="step-number-modern">
            <span>8</span>
          </div>
          <div class="ms-3 flex-grow-1">
            <h3 class="mb-1 fw-bold">Account Credentials</h3>
            <p class="text-muted mb-0">Create your secure login credentials</p>
          </div>
        </div>

        <!-- Success Alert -->
        <div *ngIf="success" class="alert alert-success-modern alert-dismissible">
          <div class="alert-content">
            <i class="bi bi-check-circle-fill"></i>
            <span>Account credentials saved successfully!</span>
          </div>
          <div class="alert-progress"></div>
        </div>

        <!-- Error Alert -->
        <div *ngIf="error" class="alert alert-danger-modern alert-dismissible">
          <div class="alert-content">
            <i class="bi bi-exclamation-triangle-fill"></i>
            <span>{{ error }}</span>
          </div>
          <button type="button" class="alert-close" (click)="error = null">
            <i class="bi bi-x-lg"></i>
          </button>
          <div class="alert-progress"></div>
        </div>

        <!-- Info Box -->
        <div class="info-box-modern mb-4">
          <i class="bi bi-shield-lock-fill"></i>
          <p class="mb-0">Create a strong username and password to secure your account.</p>
        </div>

        <!-- Form -->
        <form [formGroup]="form" (ngSubmit)="onSubmit()">
          
          <!-- Username Field -->
          <div class="form-group-full mb-4">
            <label class="form-label-horizontal">
              <i class="bi bi-person-circle me-1"></i>
              Username <span class="text-danger">*</span>
            </label>
            <div class="input-with-validation">
              <input 
                type="text" 
                class="form-control-horizontal" 
                [class.is-invalid]="form.get('username')?.invalid && form.get('username')?.touched"
                [class.is-valid]="form.get('username')?.valid && usernameAvailable"
                formControlName="username"
                placeholder="Enter username"
                autocomplete="off"
              />
              
              <!-- Loading Spinner -->
              <div class="validation-icon" *ngIf="usernameChecking">
                <div class="spinner-border spinner-border-sm text-primary"></div>
              </div>
              
              <!-- Available Icon -->
              <div class="validation-icon text-success" *ngIf="!usernameChecking && usernameAvailable">
                <i class="bi bi-check-circle-fill"></i>
              </div>
              
              <!-- Unavailable Icon -->
              <div class="validation-icon text-danger" *ngIf="!usernameChecking && usernameAvailable === false">
                <i class="bi bi-x-circle-fill"></i>
              </div>
            </div>
            
            <!-- Username Feedback -->
            <div class="invalid-feedback d-block" *ngIf="form.get('username')?.invalid && form.get('username')?.touched">
              <i class="bi bi-exclamation-circle me-1"></i>
              {{ getUsernameError() }}
            </div>
            <div class="valid-feedback d-block" *ngIf="!usernameChecking && usernameAvailable">
              <i class="bi bi-check-circle me-1"></i>
              Username is available!
            </div>
            <div class="invalid-feedback d-block" *ngIf="!usernameChecking && usernameAvailable === false">
              <i class="bi bi-x-circle me-1"></i>
              {{ usernameError }}
            </div>
            
            <!-- Username Rules -->
            <div class="field-rules mt-2">
              <small class="text-muted">
                <i class="bi bi-info-circle me-1"></i>
                Username requirements:
              </small>
              <ul class="rules-list">
                <li [class.rule-met]="usernameMinLength()">
                  <i class="bi" [class.bi-check-circle-fill]="usernameMinLength()" [class.bi-circle]="!usernameMinLength()"></i>
                  4-20 characters long
                </li>
                <li [class.rule-met]="usernameStartsWithLetter()">
                  <i class="bi" [class.bi-check-circle-fill]="usernameStartsWithLetter()" [class.bi-circle]="!usernameStartsWithLetter()"></i>
                  Must start with a letter
                </li>
                <li [class.rule-met]="usernameValidChars()">
                  <i class="bi" [class.bi-check-circle-fill]="usernameValidChars()" [class.bi-circle]="!usernameValidChars()"></i>
                  Only letters, numbers, underscore, and hyphen
                </li>
                <li [class.rule-met]="usernameNoSpaces()">
                  <i class="bi" [class.bi-check-circle-fill]="usernameNoSpaces()" [class.bi-circle]="!usernameNoSpaces()"></i>
                  No spaces allowed
                </li>
              </ul>
            </div>
          </div>

          <!-- Password Field -->
          <div class="form-group-full mb-4">
            <label class="form-label-horizontal">
              <i class="bi bi-lock-fill me-1"></i>
              Password <span class="text-danger">*</span>
            </label>
            <div class="password-input-wrapper">
              <input 
                [type]="showPassword ? 'text' : 'password'" 
                class="form-control-horizontal" 
                [class.is-invalid]="form.get('password')?.invalid && form.get('password')?.touched"
                formControlName="password"
                placeholder="Enter password"
                autocomplete="new-password"
              />
              <button 
                type="button" 
                class="password-toggle-btn" 
                (click)="togglePasswordVisibility()"
                tabindex="-1">
                <i class="bi" [class.bi-eye-fill]="!showPassword" [class.bi-eye-slash-fill]="showPassword"></i>
              </button>
            </div>
            
            <!-- Password Strength Indicator -->
            <div class="password-strength-indicator mt-2" *ngIf="form.get('password')?.value">
              <div class="strength-bar-container">
                <div class="strength-bar" 
                     [class.weak]="passwordStrength === 'weak'"
                     [class.medium]="passwordStrength === 'medium'"
                     [class.strong]="passwordStrength === 'strong'"
                     [style.width.%]="passwordStrengthPercentage">
                </div>
              </div>
              <div class="strength-label">
                <span class="strength-text" 
                      [class.text-danger]="passwordStrength === 'weak'"
                      [class.text-warning]="passwordStrength === 'medium'"
                      [class.text-success]="passwordStrength === 'strong'">
                  <i class="bi" 
                     [class.bi-shield-fill-exclamation]="passwordStrength === 'weak'"
                     [class.bi-shield-fill-check]="passwordStrength === 'medium'"
                     [class.bi-shield-fill-check]="passwordStrength === 'strong'"></i>
                  {{ passwordStrength === 'weak' ? 'Weak' : passwordStrength === 'medium' ? 'Medium' : 'Strong' }} Password
                </span>
              </div>
            </div>
            
            <!-- Password Error -->
            <div class="invalid-feedback d-block" *ngIf="form.get('password')?.invalid && form.get('password')?.touched">
              <i class="bi bi-exclamation-circle me-1"></i>
              {{ getPasswordError() }}
            </div>
            
            <!-- Password Rules -->
            <div class="field-rules mt-2">
              <small class="text-muted">
                <i class="bi bi-info-circle me-1"></i>
                Password requirements:
              </small>
              <ul class="rules-list">
                <li [class.rule-met]="passwordMinLength()">
                  <i class="bi" [class.bi-check-circle-fill]="passwordMinLength()" [class.bi-circle]="!passwordMinLength()"></i>
                  At least 8 characters
                </li>
                <li [class.rule-met]="passwordHasUppercase()">
                  <i class="bi" [class.bi-check-circle-fill]="passwordHasUppercase()" [class.bi-circle]="!passwordHasUppercase()"></i>
                  One uppercase letter
                </li>
                <li [class.rule-met]="passwordHasLowercase()">
                  <i class="bi" [class.bi-check-circle-fill]="passwordHasLowercase()" [class.bi-circle]="!passwordHasLowercase()"></i>
                  One lowercase letter
                </li>
                <li [class.rule-met]="passwordHasNumber()">
                  <i class="bi" [class.bi-check-circle-fill]="passwordHasNumber()" [class.bi-circle]="!passwordHasNumber()"></i>
                  One number
                </li>
                <li [class.rule-met]="hasSpecialChar()">
                  <i class="bi" [class.bi-check-circle-fill]="hasSpecialChar()" [class.bi-circle]="!hasSpecialChar()"></i>
                  One special character (!@#$%^&*)
                </li>
              </ul>
            </div>
          </div>

          <!-- Confirm Password Field -->
          <div class="form-group-full mb-4">
            <label class="form-label-horizontal">
              <i class="bi bi-lock-fill me-1"></i>
              Confirm Password <span class="text-danger">*</span>
            </label>
            <div class="password-input-wrapper">
              <input 
                [type]="showConfirmPassword ? 'text' : 'password'" 
                class="form-control-horizontal" 
                [class.is-invalid]="(form.errors?.['passwordMismatch'] || form.get('confirmPassword')?.invalid) && form.get('confirmPassword')?.touched"
                [class.is-valid]="form.get('confirmPassword')?.valid && !form.errors?.['passwordMismatch'] && form.get('confirmPassword')?.value"
                formControlName="confirmPassword"
                placeholder="Re-enter password"
                autocomplete="new-password"
              />
              <button 
                type="button" 
                class="password-toggle-btn" 
                (click)="toggleConfirmPasswordVisibility()"
                tabindex="-1">
                <i class="bi" [class.bi-eye-fill]="!showConfirmPassword" [class.bi-eye-slash-fill]="showConfirmPassword"></i>
              </button>
            </div>
            
            <!-- Password Match Feedback -->
            <div class="invalid-feedback d-block" *ngIf="form.errors?.['passwordMismatch'] && form.get('confirmPassword')?.touched">
              <i class="bi bi-x-circle me-1"></i>
              Passwords do not match
            </div>
            <div class="valid-feedback d-block" *ngIf="!form.errors?.['passwordMismatch'] && form.get('confirmPassword')?.value && form.get('confirmPassword')?.touched">
              <i class="bi bi-check-circle me-1"></i>
              Passwords match!
            </div>
          </div>

          <!-- Actions -->
          <div class="form-actions-horizontal mt-4">
            <button type="button" class="btn-secondary-modern" (click)="goBack()">
              <i class="bi bi-arrow-left me-2"></i>
              Back
            </button>
            <button type="submit" class="btn-primary-modern" [disabled]="form.invalid || !usernameAvailable || loading">
              <span *ngIf="!loading">
                Save and Continue
                <i class="bi bi-arrow-right ms-2"></i>
              </span>
              <span *ngIf="loading">
                <span class="spinner-border spinner-border-sm me-2"></span>
                Saving...
              </span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
